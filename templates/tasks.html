{% extends "base.html" %}

{% block title %}–ú–æ–∏ –∑–∞–¥–∞—á–∏ - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á{% endblock %}

{% block content %}

<div class="debug-info">
    <small>–í—Å–µ–≥–æ –∑–∞–¥–∞—á: {{ tasks|length }}</small>
    {% for task in tasks %}
    <small>–ó–∞–¥–∞—á–∞: {{ task.title }} | User: {{ task.user_id }} | Current User: {{ current_user.id }}</small>
    {% endfor %}
</div>

<div class="tasks-header">
    <h2>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
    <a href="{{ url_for('add_task') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</a>
</div>

<div class="filters">
    <h3>–§–∏–ª—å—Ç—Ä—ã:</h3>
    <div class="filter-buttons">
        <a href="{{ url_for('tasks') }}?filter=all" 
        class="btn {% if current_filter == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">
            –í—Å–µ ({{ task_counts.total }})
        </a>
        <a href="{{ url_for('tasks') }}?filter=active" 
        class="btn {% if current_filter == 'active' %}btn-primary{% else %}btn-secondary{% endif %}">
            –ê–∫—Ç–∏–≤–Ω—ã–µ ({{ task_counts.active }})
        </a>
        <a href="{{ url_for('tasks') }}?filter=completed" 
        class="btn {% if current_filter == 'completed' %}btn-primary{% else %}btn-secondary{% endif %}">
            –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ ({{ task_counts.completed }})
        </a>
        <a href="{{ url_for('tasks') }}?filter=overdue" 
        class="btn {% if current_filter == 'overdue' %}btn-primary{% else %}btn-secondary{% endif %}">
            –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ({{ task_counts.overdue }})
        </a>
    </div>
    
    {% if current_filter != 'all' %}
    <div class="filter-info">
        <small>–ü–æ–∫–∞–∑–∞–Ω–æ: {{ tasks|length }} –∑–∞–¥–∞—á</small>
        <a href="{{ url_for('tasks') }}" class="btn btn-sm btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</a>
    </div>
    {% endif %}
</div>

<div class="task-list">
    {% for task in tasks %}
    <div class="task-card {{ task.priority }} {% if task.completed %}completed{% endif %} {% if task.is_overdue() %}overdue{% endif %}">
        <div class="task-header">
            <h3>{{ task.title }}</h3>
            <div class="task-actions">
                <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-info">‚úèÔ∏è</a>
                {% if not task.completed %}
                <a href="{{ url_for('complete_task', task_id=task.id) }}" class="btn btn-success">‚úì</a>
                {% else %}
                <a href="{{ url_for('complete_task', task_id=task.id) }}" class="btn btn-secondary">‚Üª</a>
                {% endif %}
                <a href="{{ url_for('delete_task', task_id=task.id) }}" class="btn btn-danger" 
                onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')">‚úï</a>
            </div>
        </div>
        
        {% if task.description %}
        <p class="task-description">{{ task.description }}</p>
        {% endif %}
        
        <div class="task-meta">
            <span class="priority priority-{{ task.priority }}">
                –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ task.priority_display }}
            </span>
            
            <span class="task-status {% if task.completed %}status-completed{% elif task.is_overdue() %}status-overdue{% else %}status-active{% endif %}">
                {% if task.completed %}
                    ‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                {% elif task.is_overdue() %}
                    ‚ö† –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                {% else %}
                    –ê–∫—Ç–∏–≤–Ω–æ
                {% endif %}
            </span>
            
            {% if task.due_date %}
            <span class="due-date {% if task.is_overdue() %}overdue{% endif %}">
                –°—Ä–æ–∫: {{ task.due_date.strftime('%d.%m.%Y %H:%M') }}
            </span>
            {% endif %}
            
            {% if task.reminder_time %}
            <span class="reminder">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {{ task.reminder_time.strftime('%d.%m.%Y %H:%M') }}</span>
            {% endif %}
            
            {% if task.repeat_interval %}
            <span class="repeat">–ü–æ–≤—Ç–æ—Ä: {{ task.repeat_interval_display }}</span>
            {% endif %}
        </div>
        
        <div class="task-tags">
            {% if task.categories %}
            <div class="categories">
                {% for category in task.categories %}
                <span class="category" style="background-color: {{ category.color }}">{{ category.name }}</span>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if task.tags %}
            <div class="tags">
                {% for tag in task.tags %}
                <span class="tag">{{ tag.name }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        {% if task.attachment_path %}
        <div class="task-attachment">
            <a href="{{ url_for('download_attachment', task_id=task.id) }}" class="btn btn-secondary">
                üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
            </a>
        </div>
        {% endif %}
        
        <div class="task-footer">
            <small>–°–æ–∑–¥–∞–Ω–æ: {{ task.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
            {% if task.completed %}
            <span class="completed-badge">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
            {% endif %}
            {% if task.is_overdue() and not task.completed %}
            <span class="overdue-badge">‚ö† –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á</p>
        <a href="{{ url_for('add_task') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É</a>
    </div>
    {% endfor %}
</div>
{% endblock %}